# Nixpacks configuration for Railway deployment
# https://nixpacks.com/docs/configuration/file

providers = ["ruby"]

[variables]
RAILS_ENV = "production"
NODE_ENV = "production"
RACK_ENV = "production"
RAILS_SERVE_STATIC_FILES = "true"
RAILS_LOG_TO_STDOUT = "true"
SECRET_KEY_BASE = "placeholder_secret_key_base_for_asset_precompilation_12345678901234567890"
NODE_OPTIONS = "--max-old-space-size=4096"
BUNDLE_WITHOUT = "development:test"

[phases.setup]
nixPkgs = ["postgresql", "imagemagick", "vips", "git", "openssl"]

[phases.install]
dependsOn = ["setup"]
cmds = [
  # Create ALL necessary directories FIRST - before anything else
  "mkdir -p log tmp/pids tmp/cache tmp/sockets storage",
  "touch log/development.log log/production.log log/test.log",
  # Install Ruby dependencies
  "gem install bundler:2.5.11",
  "bundle config set --local without 'development test'",
  "bundle install -j 4",
  # Install Node dependencies  
  "corepack enable",
  "pnpm install --frozen-lockfile"
]

[phases.build]
dependsOn = ["install"]
cmds = [
  # Ensure directories exist again (in case they were cleaned)
  "mkdir -p log tmp",
  "touch log/development.log log/production.log",
  # Precompile assets with RAILS_ENV explicitly set
  "RAILS_ENV=production RACK_ENV=production SECRET_KEY_BASE=placeholder_for_precompile bundle exec rake assets:precompile"
]

[start]
cmd = "mkdir -p log tmp && bundle exec rails db:chatwoot_prepare && bundle exec rails server -b 0.0.0.0 -p ${PORT:-3000}"
